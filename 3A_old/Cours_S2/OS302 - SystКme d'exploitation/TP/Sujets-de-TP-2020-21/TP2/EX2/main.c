#include <sys/types.h>
#include <unistd.h>
#include <stdio.h>
#include <stdlib.h>
#include <sys/wait.h>
#include <signal.h>

#define RED    "\033[0;31m"
#define BLUE   "\033[0;34m"
#define GREEN  "\033[0;32m"
#define YELLOW "\033[0;33m"
#define NC     "\033[0m"

#define MAX_RUN_SEC 100
#define ROLLBACK_TRIGGER 60


void Universal_ALRM_Handler(int *compteur, char* str, pid_t target){
	(*compteur)++;
	if (*compteur == ROLLBACK_TRIGGER){
		kill(target,SIGALRM);
		*compteur=0;
	}
	printf("%d %s\n",*compteur,str);
}

int main (void) {
	
	pid_t pidS,pidM,pidH;
	pidS = 0;

	int i=0;

	if ((pidH=fork())) {
		if ( (pidM = fork()) ) { 
			if ( 0==(pidS = fork()) ) {
				/* process Secondes */
				int sec_cnt = 0;
				void on_sigalrm(int sig){
					Universal_ALRM_Handler(&sec_cnt,"secondes",pidM);
				}
				signal(SIGALRM, on_sigalrm);
				
				while(i++<MAX_RUN_SEC){alarm(1);sleep(1);}
			}
		}
		else /* process MINUTES*/
		{
			int min_cnt = 0;
			void on_sigalrm(int sig){
				Universal_ALRM_Handler(&min_cnt,"minutes",pidM);
			}
			signal(SIGALRM, on_sigalrm);
			
			
			while(i++<MAX_RUN_SEC){sleep(1);}
		}
	}
	else /* process HEURES */
	{		
		int hr_cnt = 0;
		void on_sigalrm(int sig){
			Universal_ALRM_Handler(&hr_cnt,"heures",pidM);
		}
		signal(SIGALRM, on_sigalrm);
		
		
		while(i++<MAX_RUN_SEC){sleep(1);}
	}
	if (pidS > 0) {/*pere*/
		while(i++<MAX_RUN_SEC){sleep(1);}
		printf( RED "Routine terminÃ©e.\n" NC );
	}


	exit(0);
}

