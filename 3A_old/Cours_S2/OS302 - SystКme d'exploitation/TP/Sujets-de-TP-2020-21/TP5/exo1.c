/*******************************************************************************
 * OS302 - shm - Exercice 1                                                    *
 * Utilisation des segments de memoire partagee                                *
 ******************************************************************************/
#include "segment_memoire.h"

#define NOM "exo1.c"
#define TAILLE 100
#define ID 1

#define NC  "\x1B[0m"
#define RED  "\x1B[31m"
#define GRN  "\x1B[32m"
#define YEL  "\x1B[33m"
#define BLU  "\x1B[34m"
#define MAG  "\x1B[35m"
#define CYN  "\x1B[36m"
#define WHT  "\x1B[37m"


int main(void)
{  
	int shmid = cree_segment(NOM, TAILLE, ID);
	afficher_info_segment(shmid);
	detruire_segment(shmid);
	return 0;
}

int cree_segment(char* nom, size_t taille, int id){
	key_t cle = ftok(nom, id);
	if(cle<0){
		perror("erreur de ftok");
		exit(1);
	}
	int shmid = shmget(cle, taille, IPC_CREAT | 0666) ;
	if(shmid<0){
		perror("erreur de shmget");
		exit(1);
	}
	return shmid;
}

int detruire_segment(int shmid){
	return shmctl (shmid, IPC_RMID, NULL);
}

int afficher_info_segment(int shmid){
	struct shmid_ds info;
	int code = shmctl (shmid, IPC_STAT, &info) ;
	if(code<0){
		return -1;
	}
	printf(YEL"struct"NC" ipc_perm "GRN"shm_perm"NC"   :\n");
	printf("\tuid_t          "YEL"uid"NC"  = "CYN"%d\n"NC,info.shm_perm.uid);
	printf("\tgid_t          "YEL"gid"NC"  = "CYN"%d\n"NC,info.shm_perm.gid);
	printf("\tuid_t          "YEL"cuid"NC" = "CYN"%d\n"NC,info.shm_perm.cuid);
	printf("\tgid_t          "YEL"cgid"NC" = "CYN"%d\n"NC,info.shm_perm.cgid);
	printf("\tunsidned short "YEL"mode"NC" = "CYN"%d\n"NC,info.shm_perm.mode);
	printf("\tunsidned short "YEL"seq"NC"  = "CYN"%d\n"NC,info.shm_perm.__seq);
	printf("\tkey_t          "YEL"key"NC"  = "CYN"%d\n"NC,info.shm_perm.__key);
	printf("size_t          "GRN"shm_segsz"NC"  = "CYN"%ld\n"NC,info.shm_segsz);
	printf("time_t          "GRN"shm_atime"NC"  = "CYN"%ld\n"NC,info.shm_atime);
	printf("time_t          "GRN"shm_dtime"NC"  = "CYN"%ld\n"NC,info.shm_dtime);
	printf("time_t          "GRN"shm_ctime"NC"  = "CYN"%ld\n"NC,info.shm_ctime);
	printf("pid_t           "GRN"shm_cpid"NC"   = "CYN"%d\n"NC,info.shm_cpid);
	printf("pid_t           "GRN"shm_lpid"NC"   = "CYN"%d\n"NC,info.shm_lpid);
	printf("shmatt_t        "GRN"shm_nattch"NC" = "CYN"%ld\n"NC,info.shm_nattch);
	return 0;
}