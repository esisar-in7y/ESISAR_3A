/*******************************************************************************
 * OS302 - shm - Exercice 2                                                    *
 * Utilisation des segments de memoire partagee                                *
 ******************************************************************************/

#include "segment_memoire.h"

#include <stdio.h>
#include <unistd.h>

#include <string.h>
#include <sys/wait.h>

#define NOM "exo2.c"
#define SLEEP_TIME 2

#define TAILLE 100
#define ID 1

#define NC  "\x1B[0m"
#define RED  "\x1B[31m"
#define GRN  "\x1B[32m"
#define YEL  "\x1B[33m"

int main(void)
{
	pid_t pid;
	char *mem;
	int shmid;

	/* a completer : creation du segment de memoire partagee */
	/* ... */
	shmid = cree_segment(NOM, TAILLE, ID);

	switch(pid = fork()) {
	case -1:
		perror("fork");
		return -1;
	case 0: // FILS
		sleep(SLEEP_TIME);
		/* Attachement */
		mem = shmat(shmid, NULL, 0);
		/* Affichage :
			%.*s -> prends deux parametres (int n, char* s)
				 -> premet d'afficher au max les n premiers char de s
		*/
		printf(GRN"Content"NC":"YEL"%.*s"NC"\n",TAILLE,mem);
		break;
	default: // PERE
		/* Attachement :
			shmat renvoie une addresse vers la zone de memoire partag√©e
		*/
		mem = shmat(shmid, NULL, 0);
		/* Ecriture : */
		memcpy(mem,"SOURIS CITY",12);
		/*-------------------------------------------------------------------*/
		/* Attente de la mort du fils: */
		waitpid(pid, NULL, 0);
		/* Detachement: */
		shmdt(mem);
		/* Destructtion: */
		detruire_segment(shmid);
	}

	return 0;
}

int cree_segment(char* nom, size_t taille, int id){
	key_t cle = ftok(nom, id);
	if(cle<0){
		perror("erreur de ftok");
		exit(1);
	}
	int shmid = shmget(cle, taille, IPC_CREAT | 0666) ;
	if(shmid<0){
		perror("erreur de shmget");
		exit(1);
	}
	return shmid;
}

int detruire_segment(int shmid){
	return shmctl (shmid, IPC_RMID, NULL);
}
